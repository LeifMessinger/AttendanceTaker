{% extends "layout.html" %}
{% block left_content %}
	<!-- This is where the present people go -->
	<!-- Make Copy JSON button that queries the server for the present list and puts it in the clipboard -->
	<!-- Make live attendance with htmx that updates every second. It can just render a template that loops through the students. -->
	<style>
		h2 {
			font-size: 200%;
		}
		#absenceList{
			max-height: 90vh;
			overflow: scroll;
		}
	</style>

	<h2>Absent:</h2>
	<div id="absenceList"></div>
	<button onclick="copyJSONAbsenceList()">Copy JSON</button>

	{% load static %}
	<script src="{% static 'AttendanceTaker/qrcodejs/qrcode.min.js' %}" type="text/javascript"></script>
	<script type="text/javascript">
		const absenceListElement = document.getElementById("absenceList");

		function copyString(text){
			//Could be refactored a little bit for repetition
			if(!(document.execCommand)){
				console.warn("They finally deprecated document.execCommand!");
			}
			if(document.location.protocol == "https:"){
				navigator.clipboard.writeText(text).catch(()=>{
					const input = document.createElement('textarea');
					input.value = text;
					document.body.appendChild(input);
					input.select();
					const success = document.execCommand('copy');
					document.body.removeChild(input);

					if(!success){
						prompt("Copy failed. Might have ... somewhere. Check console.", text);
					}else{
						alert("Copied to clipboard");
					}
				});
			}else{
				const input = document.createElement('textarea');
				input.value = text;
				document.body.appendChild(input);
				input.select();
				const success = document.execCommand('copy');
				document.body.removeChild(input);

				if(!success){
					prompt("Copy failed. Might have ... somewhere. Check console.", text);
				}else{
					alert("Copied to clipboard");
				}
			}
		}
		function copyJSONAbsenceList(){
			fetch("{% url 'ClassroomAbsenceList' %}").then((res)=>res.json()).then((data)=>data["data"]).then((absenceList)=>{
				console.log(absenceList);
				copyString(JSON.stringify(absenceList));
			});
		}
		function buildAbsenceList(absenceList) {
			const parent = document.createElement('div');

			for (let studentName of absenceList) {
				const name = document.createElement('span');
                                name.textContent = studentName;

				parent.appendChild(name);
                                parent.appendChild(document.createElement('br'));
			}

			return parent;
		}

		setInterval(()=>{
			fetch("{% url 'ClassroomAbsenceList' %}").then((res)=>res.json()).then((data)=>data["data"]).then((absenceList)=>{
				//console.log(absenceList);
				absenceListElement.innerHTML = "";
				absenceListElement.appendChild(buildAbsenceList(absenceList));
			});
		}, 1000);
	</script>
{% endblock %}

{% block middle_content %}
	<p style="font-size: 10vh; margin-left: auto; margin-right: auto;">Scan me!</p>
	<!-- Maybe use htmx to swap the image. Use {bruh% url 'AttendanceTaker.QR' } as the image source' -->
	<style>
		#qrcode{
			width: 70%;
			margin: auto;
		}
		#qrcode>img{
			width: 100%;

			image-rendering: pixelated;
			image-rendering: -moz-crisp-edges;
			image-rendering: crisp-edges;

			cursor: none; //So that the teacher doesn't accidentally lay the mouse on the QR code
		}
	</style>

	<script>
		function studentSignIn(){
			fetch("{% url 'ClassroomQRCode' %}").then((res)=>res.json()).then((data)=>data["data"]).then((base64String)=>{
				window.location = document.location.origin + "/" + base64String;
			});
		}
	</script>

	<a onclick="studentSignIn">
		<div id="qrcode"></div>
	</a>
	<p style="margin-left: auto; margin-right: auto;">This webapp requires cookies to work.</p>

	{% load static %}
	<script src="{% static 'AttendanceTaker/qrcodejs/qrcode.min.js' %}" type="text/javascript"></script>
	<script type="text/javascript">
		const qrDiv = document.getElementById("qrcode");

		const qrcode = new QRCode(qrDiv, {
			//text: "bruh",
			width: 100,
			height: 100,
			colorDark : "#000000",
			colorLight : "#ffffff",
			correctLevel : QRCode.CorrectLevel.H,
		});

		setInterval(()=>{
			fetch("{% url 'ClassroomQRCode' %}").then((res)=>res.json()).then((data)=>data["data"]).then((base64String)=>{
				const studentURL = document.location.origin + "/" + base64String;
				qrcode.makeCode(studentURL);

				qrDiv.parentElement.setAttribute("href", studentURL);
				//console.log(base64String);
			});
		}, 1000);	//This QR code can be behind by a second, but that isn't too bad.
	</script>
{% endblock %}

{% block right_content %}
	<!-- This is where the present people go -->
	<!-- Make Copy JSON button that queries the server for the present list and puts it in the clipboard -->
	<!-- Make live attendance with htmx that updates every second. It can just render a template that loops through the students. -->
	<style>
		h2 {
			font-size: 200%;
		}
		button {
            		background-color: #007bff;
            		color: #fff;
            		border: none;
            		padding: 10px 20px;
            		margin-top: 10px;
            		cursor: pointer;
        	}

        	button:hover {
            		background-color: #0056b3;
        	}
		#attendanceList{
			max-height: 90vh;
			overflow: scroll;
		}
	</style>

	<script>
		function copyString(text){
			//Could be refactored a little bit for repetition
			if(!(document.execCommand)){
				console.warn("They finally deprecated document.execCommand!");
			}
			if(document.location.protocol == "https:"){
				navigator.clipboard.writeText(text).catch(()=>{
					const input = document.createElement('textarea');
					input.value = text;
					document.body.appendChild(input);
					input.select();
					const success = document.execCommand('copy');
					document.body.removeChild(input);

					if(!success){
						prompt("Copy failed. Might have ... somewhere. Check console.", text);
					}else{
						alert("Copied to clipboard");
					}
				});
			}else{
				const input = document.createElement('textarea');
				input.value = text;
				document.body.appendChild(input);
				input.select();
				const success = document.execCommand('copy');
				document.body.removeChild(input);

				if(!success){
					prompt("Copy failed. Might have ... somewhere. Check console.", text);
				}else{
					alert("Copied to clipboard");
				}
			}
		}
		function copyJSONList(){
			fetch("{% url 'ClassroomAttendanceList' %}").then((res)=>res.json()).then((data)=>data["data"]).then((attendanceList)=>{
				console.log(attendanceList);
				copyString(JSON.stringify(attendanceList));
			});
		}
		function copyCSVList(){
			const attendencelist=attendanceList.join(',');
			console.log(attendencelist);//NOT YET IMPLEMENTED
		}
	</script>

	<h2><div id="presentNumber" style="display: inline;"></div> Present:</h2>
	<p id="attendanceList"></p>
	<!--<button onclick="copyCSVList()">Copy CSV</button> Uncomment this to test your button-->
	<button onclick="copyJSONList()">Copy JSON</button>

	{% load static %}
	<script src="{% static 'AttendanceTaker/qrcodejs/qrcode.min.js' %}" type="text/javascript"></script>
	<script type="text/javascript">
		const attendanceListElement = document.getElementById("attendanceList");

		function buildAttendanceList(details) {
			const errorCodes = {
				1: 'red',
				2: 'orange',
				3: 'black'	//I don't really consider this to be an error
			};

			const parent = document.createElement('div');

			for (let studentName of Object.keys(details)) {
				const name = document.createElement('span');
				name.textContent = studentName;

				const studentSusReasons = details[studentName];
				if (studentSusReasons.length > 0) {	//The color becomes the first issue in the list, which should be the most important one.
					const errorCode = studentSusReasons[0][0];	//[0] First error [0] error code
					name.style.setProperty("color", errorCodes[errorCode]);
					function stringifyErrors(errors){
						str = "";
						for(let error of errors){
							switch(error[0]) {
								case 1:
									str += "This student shares the same cookie as " + error[1] + ". \n";
									break;
								case 2:
									str += "This student shares the ip address as " + error[1] + ". \n";
									break;
								case 3:
									str += "A new cookie was created for this user." + " \n";
									break;
								default:
									// code block
							}
						}
						return str;
					}
					name.title = stringifyErrors(studentSusReasons);	//This is like the alt text of text.
				}

				parent.appendChild(name);
				parent.appendChild(document.createElement('br'));
			}

			return parent;
		}

		setInterval(()=>{
			fetch("{% url 'ClassroomAttendanceDetails' %}").then((res)=>res.json()).then((data)=>data["data"]).then((attendanceList)=>{
				attendanceListElement.innerHTML = "";
				attendanceListElement.appendChild(buildAttendanceList(attendanceList));
			});
		}, 1000);
	</script>
{% endblock %}

